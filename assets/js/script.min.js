window.BPMsgAt_Media_Uploader=function(t,e){var a=!1,l=e.uploader||{},o=e.lang,r=e.selectors,n={},i={init:function(){var e=this;return e.get_elements()?(setTimeout(function(){e.start_uploader()},10),void t.ajaxPrefilter(i.prefilter)):!1},get_elements:function(){return n.$form=t("compose"==e.current_action?r.form_message:r.form_reply),0===n.$form.length?!1:(n.$button=n.$form.find('input[type="submit"],button[type="submit"]'),n.$field_attachment_ids=n.$form.find('input[name="bp_msgat_attachment_ids"]'),n.$upload_button=t("#btn_msgat_upload"),!0)},get_query_variable:function(t,e){if("undefined"==typeof t||""==t||"undefined"==typeof e||""==e)return"";for(var a=t.split("&"),l=0;l<a.length;l++){var o=a[l].split("=");if(o[0]==e)return o[1]}return!1},prefilter:function(e,a){var l=i.get_query_variable(e.data,"action");if("undefined"!=typeof l&&"messages_send_reply"==l){var o=t.extend({},a.data,{bp_msgat_attachment_ids:n.$field_attachment_ids.val()});e.data=t.param(o),e.success=function(e){return n.$field_attachment_ids.val(""),t(".msgat-uploaded-file").remove(),function(a,l,o){t.isFunction(e)&&e(a,l,o)}}(e.success)}},start_uploader:function(){a=new plupload.Uploader({runtimes:"html5,silverlight,flash,html4",browse_button:"btn_msgat_upload",dragdrop:!1,max_file_size:l.max_file_size||"5mb",multi_selection:l.multiselect||!1,url:ajaxurl,multipart:!0,multipart_params:{action:"bp_msgat_upload",cookie:encodeURIComponent(document.cookie),_wpnonce:l.nonce},flash_swf_url:l.swf_url||"",silverlight_xap_url:l.silverlight_xap_url||"",filters:l.filters,init:{FilesAdded:function(t){n.$button.attr("disabled","disabled").addClass("loading");var e=n.$upload_button.html();n.$upload_button.attr("disabled","disabled").addClass("loading").data("org_text",e).html(o.uploading),t.start()},FileUploaded:function(e,a,r){n.$button.removeAttr("disabled").removeClass("loading"),n.$upload_button.removeAttr("disabled").removeClass("loading").html(n.$upload_button.data("org_text"));var i=t.parseJSON(r.response),d=n.$field_attachment_ids.val();if(l.multiselect);else{d=i.attachment_id,t(".msgat-uploaded-file").remove();var s="<span class='msgat-uploaded-file'>"+i.name+"<a href='#' data-attachment_id='"+i.attachment_id+"' class='remove-uploaded-file'  onclick='return window.BPMsgAt_Media_Uploader.removeAttachment(this)'  title='"+o.remove+"'>x</a></span>";t("#btn_msgat_upload").after(s)}n.$field_attachment_ids.val(d)},Error:function(t,e){n.$button.removeAttr("disabled").removeClass("loading"),n.$upload_button.removeAttr("disabled").removeClass("loading").html(n.$upload_button.data("org_text")),i.show_upload_error(e.code),t.refresh(),l.multiselect||n.$field_attachment_ids.val("")}}}),a.init()},show_upload_error:function(t){switch(t){case plupload.FILE_EXTENSION_ERROR:alert(o.upload_error.file_type);break;case plupload.FILE_SIZE_ERROR:alert(o.upload_error.file_size);break;default:alert(o.upload_error.generic)}},removeAttachment:function(e){return $el=t(e),n.$field_attachment_ids.val(""),$el.closest(".msgat-uploaded-file").remove(),!1}},d={setup:function(){i.init()},removeAttachment:function(t){return i.removeAttachment(t)}};return t(document).ready(function(){i.init()}),d}(window.jQuery,window.BPMsgAt_Util);